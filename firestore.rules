rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // ======== FUNCIONES AUXILIARES ========
    
    // Función para verificar si el usuario está autenticado
    function isAuthenticated() {
      return request.auth != null;
    }

    // Función para verificar si el usuario es el propietario del documento
    function isOwner(userId) {
      return request.auth.uid == userId;
    }
    
    // Función para verificar si es el usuario del lead (para documentos existentes)
    function isLeadUser() {
      return resource.data.userId == request.auth.uid;
    }
    
    // Función para verificar si es el proveedor del lead (para documentos existentes)
    function isLeadProvider() {
      return resource.data.providerId == request.auth.uid;
    }
    
    // Función para verificar si es el usuario del lead (para nuevos documentos)
    function isNewLeadUser() {
      return request.resource.data.userId == request.auth.uid;
    }
    
    // ======== FUNCIONES DE ADMIN ========
    
    // Verificar si el usuario tiene el claim de admin
    function isAdmin() {
      return isAuthenticated() && request.auth.token.admin == true;
    }
    
    // Verificar si el usuario tiene el claim de super_admin
    function isSuperAdmin() {
      return isAuthenticated() && request.auth.token.super_admin == true;
    }
    
    // Verificar si es admin o super_admin
    function hasAdminAccess() {
      return isAdmin() || isSuperAdmin();
    }
    
    // ======== FUNCIONES DE VALIDACIÓN DE LEADS ========
    
    // Verificar que los campos de leads del proveedor son válidos
    function isValidLeadFields() {
      return request.resource.data.leadLimit is number 
        && request.resource.data.leadLimit >= 0
        && request.resource.data.leadsUsed is number 
        && request.resource.data.leadsUsed >= 0;
    }
    
    // Verificar que el proveedor no modifica sus propios campos de leads críticos
    // Solo admin puede modificar leadLimit, leadsUsed, status e isVerified
    // categoryLeadLimits y categoryLeadsUsed pueden ser modificados al agregar nuevas categorías
    // pero no se pueden reducir los límites existentes ni resetear los contadores de uso
    // metrics puede ser actualizado por el sistema cuando usuarios interactúan con leads
    function providerCannotModifyLeadFields() {
      return !request.resource.data.diff(resource.data).affectedKeys().hasAny([
        'leadLimit', 
        'leadsUsed', 
        'status',
        'isVerified'
      ]);
    }
    
    // Verificar si solo se están actualizando métricas del proveedor
    // Esto permite que el sistema actualice métricas cuando usuarios aprueban/rechazan leads
    function isOnlyMetricsUpdate() {
      return request.resource.data.diff(resource.data).affectedKeys().hasOnly(['metrics', 'updatedAt']);
    }
    
    // Verificar que al agregar categorías, solo se inicializan nuevas (no se modifican existentes)
    // Permite agregar nuevas categorías con sus límites/contadores iniciales
    function isValidCategoryUpdate() {
      // Si no hay cambios en categories, categoryLeadLimits o categoryLeadsUsed, es válido
      let changedKeys = request.resource.data.diff(resource.data).affectedKeys();
      let categoryFieldsChanged = changedKeys.hasAny(['categories', 'categoryLeadLimits', 'categoryLeadsUsed', 'categorySurveyStatus']);
      
      // Si no se modifican campos de categoría, permitir
      return !categoryFieldsChanged || (
        // Si se modifican, verificar que las categorías existentes no pierdan sus valores
        // Los valores de categoryLeadsUsed para categorías existentes no pueden decrementarse
        true // Permitimos la actualización - la validación detallada se hace en el cliente
      );
    }

    // ======== REGLAS PARA CADA COLECCIÓN ========
 
    // USUARIOS (Novios)
    // Los proveedores NO pueden leer directamente los perfiles de usuarios
    // La información necesaria está denormalizada en los leads (userInfo)
    match /users/{userId} {
      // Lectura: Solo el propio usuario o admins pueden leer
      // Los proveedores acceden a la info del usuario a través del lead (userInfo)
      allow read: if isAuthenticated() && (isOwner(userId) || hasAdminAccess());
      
      // Creación: Usuario autenticado puede crear su propio perfil
      allow create: if isAuthenticated() && isOwner(userId);
      
      // Actualización: El propio usuario o admins pueden actualizar
      allow update: if isAuthenticated() && (isOwner(userId) || hasAdminAccess());
      
      // Eliminación: Solo super_admin puede eliminar
      allow delete: if isSuperAdmin();
    }

    // PROVEEDORES
    match /providers/{providerId} {
      // Lectura pública: Cualquiera puede ver perfiles de proveedores (necesario para matching)
      allow read: if true;
      
      // Creación: Usuario autenticado puede crear su propio perfil de proveedor
      allow create: if isAuthenticated() && isOwner(providerId);
      
      // Actualización: 
      // - El propio proveedor puede actualizar EXCEPTO campos de leads críticos, status e isVerified
      // - El proveedor puede agregar nuevas categorías y sus campos asociados
      // - Admins pueden actualizar cualquier campo (incluyendo isVerified)
      // - Sistema puede actualizar categoryLeadsUsed cuando se crea un lead (via el usuario que crea el lead)
      // - Sistema puede actualizar metrics cuando un usuario aprueba/rechaza un lead
      allow update: if isAuthenticated() && (
        (isOwner(providerId) && providerCannotModifyLeadFields() && isValidCategoryUpdate()) || 
        hasAdminAccess() ||
        // Permitir actualización de leadsUsed/categoryLeadsUsed cuando un usuario crea un lead
        // Esto es necesario para el sistema de matching
        (request.resource.data.diff(resource.data).affectedKeys().hasOnly(['categoryLeadsUsed', 'leadsUsed', 'updatedAt'])) ||
        // Permitir actualización de métricas cuando un usuario aprueba/rechaza un lead
        // Esto es necesario para el tracking de conversiones
        isOnlyMetricsUpdate()
      );
      
      // Eliminación: Solo super_admin puede eliminar
      allow delete: if isSuperAdmin();
    }

    // LEADS/MATCHES (por categoría)
    // Esta es la colección principal que conecta usuarios con proveedores
    // Contiene userInfo denormalizado para que los proveedores tengan acceso a la info necesaria
    // También contiene userSurveyId para que los proveedores puedan acceder a la encuesta del usuario
    match /leads/{leadId} {
      // Lectura: Usuario o proveedor del lead pueden leer
      // El proveedor solo puede ver los leads donde él es el providerId
      allow read: if isAuthenticated() && (
        isLeadUser() || 
        isLeadProvider() || 
        hasAdminAccess()
      );
      
      // Creación: Usuarios autenticados pueden crear leads (sistema de matching)
      // El userId del nuevo lead debe ser el usuario autenticado
      allow create: if isAuthenticated() && isNewLeadUser();
      
      // Actualización: Usuario, proveedor del lead, o admin pueden actualizar el estado
      allow update: if isAuthenticated() && (isLeadUser() || isLeadProvider() || hasAdminAccess());
      
      // Eliminación: Solo admins pueden eliminar leads
      allow delete: if hasAdminAccess();
    }

    // ENCUESTAS DE USUARIOS POR CATEGORÍA
    // Contienen preferencias de servicio (no datos personales sensibles como email, teléfono, etc.)
    // Los proveedores pueden leer encuestas específicas si tienen el ID (obtenido del lead)
    // NOTA: No podemos validar que el proveedor tenga un lead con este usuario sin hacer queries
    // Por seguridad, las encuestas de usuario solo contienen preferencias de servicio
    // Los datos personales sensibles están en /users/ (protegido) y denormalizados en /leads/
    match /userCategorySurveys/{surveyId} {
      // Lectura: 
      // - El propio usuario puede leer sus encuestas
      // - Cualquier usuario autenticado puede leer por ID específico (get)
      //   Esto permite a los proveedores leer encuestas de sus leads
      //   La encuesta NO contiene datos personales, solo preferencias de servicio
      // - Admins pueden leer todo
      // - NO se permite listar/query sin ser el usuario o admin
      allow get: if isAuthenticated();
      
      // Lista/Query: Solo el propio usuario o admins pueden listar
      // Esto previene que proveedores listen todas las encuestas
      allow list: if isAuthenticated() && (
        // El usuario puede listar sus propias encuestas
        // Nota: Esta condición se evalúa contra cada documento en el resultado
        resource.data.userId == request.auth.uid ||
        hasAdminAccess()
      );
      
      // Creación: Usuario autenticado puede crear su propia encuesta
      allow create: if isAuthenticated() && 
        request.resource.data.userId == request.auth.uid;
      
      // Actualización: El propio usuario o admins pueden actualizar
      allow update: if isAuthenticated() && (
        resource.data.userId == request.auth.uid || 
        hasAdminAccess()
      );
      
      // Eliminación: Solo admins pueden eliminar
      allow delete: if hasAdminAccess();
    }

    // ENCUESTAS DE PROVEEDORES POR CATEGORÍA
    match /providerCategorySurveys/{surveyId} {
      // Lectura: Cualquier usuario autenticado puede leer (necesario para matchmaking)
      // Las encuestas de proveedores son públicas para permitir el matching
      allow read: if isAuthenticated();
      
      // Creación: Proveedor autenticado puede crear su propia encuesta
      allow create: if isAuthenticated() && 
        request.resource.data.providerId == request.auth.uid;
      
      // Actualización: El propio proveedor o admins pueden actualizar
      allow update: if isAuthenticated() && (
        resource.data.providerId == request.auth.uid || 
        hasAdminAccess()
      );
      
      // Eliminación: Solo admins pueden eliminar
      allow delete: if hasAdminAccess();
    }

    // ADMINISTRADORES
    match /admins/{adminId} {
      // Lectura: Solo el propio admin o super_admins pueden leer
      allow read: if isAuthenticated() && (isOwner(adminId) || isSuperAdmin());
      
      // Creación: Solo super_admin puede crear nuevos admins
      allow create: if isSuperAdmin();
      
      // Actualización: Solo super_admin puede actualizar perfiles de admin
      allow update: if isSuperAdmin();
      
      // Eliminación: Solo super_admin puede eliminar admins
      allow delete: if isSuperAdmin();
    }

    // CONFIGURACIÓN DE MATCHMAKING
    // Solo super_admin puede leer/escribir la configuración de pesos del matchmaking
    match /matchmaking_config/{configId} {
      // Lectura: Super admin puede leer la configuración
      allow read: if isSuperAdmin();
      
      // Escritura: Solo super_admin puede crear/actualizar/eliminar
      allow create: if isSuperAdmin();
      allow update: if isSuperAdmin();
      allow delete: if isSuperAdmin();
    }

    // REGLA POR DEFECTO: Denegar todo lo que no esté explícitamente permitido
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
