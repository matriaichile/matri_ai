rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // ======== FUNCIONES AUXILIARES ========
    
    // Función para verificar si el usuario está autenticado
    function isAuthenticated() {
      return request.auth != null;
    }

    // Función para verificar si el usuario es el propietario del documento
    function isOwner(userId) {
      return request.auth.uid == userId;
    }
    
    // Función para verificar si es el usuario del lead (para documentos existentes)
    function isLeadUser() {
      return resource.data.userId == request.auth.uid;
    }
    
    // Función para verificar si es el proveedor del lead (para documentos existentes)
    function isLeadProvider() {
      return resource.data.providerId == request.auth.uid;
    }
    
    // Función para verificar si es el usuario del lead (para nuevos documentos)
    function isNewLeadUser() {
      return request.resource.data.userId == request.auth.uid;
    }
    
    // ======== FUNCIONES DE ADMIN ========
    
    // Verificar si el usuario tiene el claim de admin
    function isAdmin() {
      return isAuthenticated() && request.auth.token.admin == true;
    }
    
    // Verificar si el usuario tiene el claim de super_admin
    function isSuperAdmin() {
      return isAuthenticated() && request.auth.token.super_admin == true;
    }
    
    // Verificar si es admin o super_admin
    function hasAdminAccess() {
      return isAdmin() || isSuperAdmin();
    }
    
    // ======== FUNCIONES DE VALIDACIÓN DE LEADS ========
    
    // Verificar que los campos de leads del proveedor son válidos
    function isValidLeadFields() {
      return request.resource.data.leadLimit is number 
        && request.resource.data.leadLimit >= 0
        && request.resource.data.leadsUsed is number 
        && request.resource.data.leadsUsed >= 0;
    }
    
    // Verificar que el proveedor no modifica sus propios campos de leads
    // Solo admin puede modificar leadLimit, leadsUsed, categoryLeadLimits, categoryLeadsUsed y status
    function providerCannotModifyLeadFields() {
      return !request.resource.data.diff(resource.data).affectedKeys().hasAny([
        'leadLimit', 
        'leadsUsed', 
        'categoryLeadLimits', 
        'categoryLeadsUsed', 
        'status'
      ]);
    }

    // ======== REGLAS PARA CADA COLECCIÓN ========
 
    // USUARIOS (Novios)
    match /users/{userId} {
      // Lectura: El propio usuario o admins pueden leer
      allow read: if isAuthenticated() && (isOwner(userId) || hasAdminAccess());
      
      // Creación: Usuario autenticado puede crear su propio perfil
      allow create: if isAuthenticated() && isOwner(userId);
      
      // Actualización: El propio usuario o admins pueden actualizar
      allow update: if isAuthenticated() && (isOwner(userId) || hasAdminAccess());
      
      // Eliminación: Solo super_admin puede eliminar
      allow delete: if isSuperAdmin();
    }

    // PROVEEDORES
    match /providers/{providerId} {
      // Lectura pública: Cualquiera puede ver perfiles de proveedores (necesario para matching)
      allow read: if true;
      
      // Creación: Usuario autenticado puede crear su propio perfil de proveedor
      allow create: if isAuthenticated() && isOwner(providerId);
      
      // Actualización: 
      // - El propio proveedor puede actualizar EXCEPTO campos de leads y status
      // - Admins pueden actualizar cualquier campo
      // - Sistema puede actualizar categoryLeadsUsed cuando se crea un lead (via el usuario que crea el lead)
      allow update: if isAuthenticated() && (
        (isOwner(providerId) && providerCannotModifyLeadFields()) || 
        hasAdminAccess() ||
        // Permitir actualización de leadsUsed/categoryLeadsUsed cuando un usuario crea un lead
        // Esto es necesario para el sistema de matching
        (request.resource.data.diff(resource.data).affectedKeys().hasOnly(['categoryLeadsUsed', 'leadsUsed', 'updatedAt']))
      );
      
      // Eliminación: Solo super_admin puede eliminar
      allow delete: if isSuperAdmin();
    }

    // LEADS/MATCHES (por categoría)
    match /leads/{leadId} {
      // Lectura: Usuario autenticado puede leer sus propios leads o leads donde es proveedor
      // Usamos una query más permisiva para permitir listar leads
      allow read: if isAuthenticated() && (
        isLeadUser() || 
        isLeadProvider() || 
        hasAdminAccess()
      );
      
      // Listar leads: Usuarios pueden listar sus propios leads
      // Esto es necesario para queries con where
      allow list: if isAuthenticated();
      
      // Creación: Usuarios autenticados pueden crear leads (sistema de matching)
      allow create: if isAuthenticated() && isNewLeadUser();
      
      // Actualización: Usuario, proveedor, o admin pueden actualizar el estado
      allow update: if isAuthenticated() && (isLeadUser() || isLeadProvider() || hasAdminAccess());
      
      // Eliminación: Solo admins pueden eliminar leads
      allow delete: if hasAdminAccess();
    }

    // ENCUESTAS DE USUARIOS POR CATEGORÍA
    match /userCategorySurveys/{surveyId} {
      // Lectura: El propio usuario o admins pueden leer
      allow read: if isAuthenticated() && (
        resource.data.userId == request.auth.uid || 
        hasAdminAccess()
      );
      
      // Creación: Usuario autenticado puede crear su propia encuesta
      allow create: if isAuthenticated() && 
        request.resource.data.userId == request.auth.uid;
      
      // Actualización: El propio usuario o admins pueden actualizar
      allow update: if isAuthenticated() && (
        resource.data.userId == request.auth.uid || 
        hasAdminAccess()
      );
      
      // Eliminación: Solo admins pueden eliminar
      allow delete: if hasAdminAccess();
    }

    // ENCUESTAS DE PROVEEDORES POR CATEGORÍA
    match /providerCategorySurveys/{surveyId} {
      // Lectura: Cualquier usuario autenticado puede leer (necesario para matchmaking)
      // Las encuestas de proveedores son públicas para permitir el matching
      allow read: if isAuthenticated();
      
      // Listar: Necesario para queries con where en el matching
      allow list: if isAuthenticated();
      
      // Creación: Proveedor autenticado puede crear su propia encuesta
      allow create: if isAuthenticated() && 
        request.resource.data.providerId == request.auth.uid;
      
      // Actualización: El propio proveedor o admins pueden actualizar
      allow update: if isAuthenticated() && (
        resource.data.providerId == request.auth.uid || 
        hasAdminAccess()
      );
      
      // Eliminación: Solo admins pueden eliminar
      allow delete: if hasAdminAccess();
    }

    // ADMINISTRADORES
    match /admins/{adminId} {
      // Lectura: Solo el propio admin o super_admins pueden leer
      allow read: if isAuthenticated() && (isOwner(adminId) || isSuperAdmin());
      
      // Creación: Solo super_admin puede crear nuevos admins
      allow create: if isSuperAdmin();
      
      // Actualización: Solo super_admin puede actualizar perfiles de admin
      allow update: if isSuperAdmin();
      
      // Eliminación: Solo super_admin puede eliminar admins
      allow delete: if isSuperAdmin();
    }

    // REGLA POR DEFECTO: Denegar todo lo que no esté explícitamente permitido
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
