rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // ======== FUNCIONES AUXILIARES ========
    
    // Función para verificar si el usuario está autenticado
    function isAuthenticated() {
      return request.auth != null;
    }

    // Función para verificar si el usuario es el propietario del documento
    function isOwner(userId) {
      return request.auth.uid == userId;
    }
    
    // Función para verificar si es el usuario del lead
    function isLeadUser() {
      return resource.data.userId == request.auth.uid;
    }
    
    // Función para verificar si es el proveedor del lead
    function isLeadProvider() {
      return resource.data.providerId == request.auth.uid;
    }
    
    // ======== FUNCIONES DE ADMIN ========
    
    // Verificar si el usuario tiene el claim de admin
    function isAdmin() {
      return isAuthenticated() && request.auth.token.admin == true;
    }
    
    // Verificar si el usuario tiene el claim de super_admin
    function isSuperAdmin() {
      return isAuthenticated() && request.auth.token.super_admin == true;
    }
    
    // Verificar si es admin o super_admin
    function hasAdminAccess() {
      return isAdmin() || isSuperAdmin();
    }
    
    // ======== FUNCIONES DE VALIDACIÓN DE LEADS ========
    
    // Verificar que los campos de leads del proveedor son válidos
    function isValidLeadFields() {
      return request.resource.data.leadLimit is number 
        && request.resource.data.leadLimit >= 0
        && request.resource.data.leadsUsed is number 
        && request.resource.data.leadsUsed >= 0;
    }
    
    // Verificar que el proveedor no modifica sus propios campos de leads
    // Solo admin puede modificar leadLimit y leadsUsed
    function providerCannotModifyLeadFields() {
      return !request.resource.data.diff(resource.data).affectedKeys().hasAny(['leadLimit', 'leadsUsed', 'status']);
    }

    // ======== REGLAS PARA CADA COLECCIÓN ========
 
    // USUARIOS (Novios)
    match /users/{userId} {
      // Lectura: El propio usuario o admins pueden leer
      allow read: if isAuthenticated() && (isOwner(userId) || hasAdminAccess());
      
      // Creación: Usuario autenticado puede crear su propio perfil
      allow create: if isAuthenticated() && isOwner(userId);
      
      // Actualización: El propio usuario o admins pueden actualizar
      allow update: if isAuthenticated() && (isOwner(userId) || hasAdminAccess());
      
      // Eliminación: Solo super_admin puede eliminar
      allow delete: if isSuperAdmin();
    }

    // PROVEEDORES
    match /providers/{providerId} {
      // Lectura pública: Cualquiera puede ver perfiles de proveedores
      allow read: if true;
      
      // Creación: Usuario autenticado puede crear su propio perfil de proveedor
      // El perfil debe incluir leadLimit y leadsUsed con valores válidos
      allow create: if isAuthenticated() && isOwner(providerId);
      
      // Actualización: 
      // - El propio proveedor puede actualizar EXCEPTO leadLimit, leadsUsed y status
      // - Admins pueden actualizar cualquier campo
      allow update: if isAuthenticated() && (
        (isOwner(providerId) && providerCannotModifyLeadFields()) || 
        hasAdminAccess()
      );
      
      // Eliminación: Solo super_admin puede eliminar
      allow delete: if isSuperAdmin();
    }

    // LEADS/MATCHES
    match /leads/{leadId} {
      // Lectura: El usuario, el proveedor involucrado, o admins pueden leer
      allow read: if isAuthenticated() && (isLeadUser() || isLeadProvider() || hasAdminAccess());
      
      // Creación: Usuarios autenticados o admins pueden crear leads
      // El sistema debe verificar que el proveedor tenga leads disponibles (se hace en el backend)
      allow create: if isAuthenticated() && 
        (request.resource.data.userId == request.auth.uid || hasAdminAccess());
      
      // Actualización: Usuario, proveedor, o admin pueden actualizar el estado
      allow update: if isAuthenticated() && (isLeadUser() || isLeadProvider() || hasAdminAccess());
      
      // Eliminación: Solo admins pueden eliminar leads
      allow delete: if hasAdminAccess();
    }

    // ADMINISTRADORES
    match /admins/{adminId} {
      // Lectura: Solo el propio admin o super_admins pueden leer
      allow read: if isAuthenticated() && (isOwner(adminId) || isSuperAdmin());
      
      // Creación: Solo super_admin puede crear nuevos admins
      allow create: if isSuperAdmin();
      
      // Actualización: Solo super_admin puede actualizar perfiles de admin
      allow update: if isSuperAdmin();
      
      // Eliminación: Solo super_admin puede eliminar admins
      allow delete: if isSuperAdmin();
    }

    // REGLA POR DEFECTO: Denegar todo lo que no esté explícitamente permitido
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
