rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // ======== FUNCIONES AUXILIARES ========
    
    // Función para verificar si el usuario está autenticado
    function isAuthenticated() {
      return request.auth != null;
    }

    // Función para verificar si el usuario es el propietario del documento
    function isOwner(userId) {
      return request.auth.uid == userId;
    }
    
    // Función para verificar si es el usuario del lead
    function isLeadUser() {
      return resource.data.userId == request.auth.uid;
    }
    
    // Función para verificar si es el proveedor del lead
    function isLeadProvider() {
      return resource.data.providerId == request.auth.uid;
    }

    // ======== REGLAS PARA CADA COLECCIÓN ========
 
    // USUARIOS (Novios)
    match /users/{userId} {
      // Lectura: Solo el propio usuario puede leer su perfil
      allow read: if isAuthenticated() && isOwner(userId);
      
      // Creación: Usuario autenticado puede crear su propio perfil
      allow create: if isAuthenticated() && isOwner(userId);
      
      // Actualización: Solo el propio usuario puede actualizar su perfil
      allow update: if isAuthenticated() && isOwner(userId);
      
      // Eliminación: No permitida desde el cliente
      allow delete: if false;
    }

    // PROVEEDORES
    match /providers/{providerId} {
      // Lectura pública: Cualquiera puede ver perfiles de proveedores activos
      // Lectura completa: Solo el propio proveedor ve todos sus datos
      allow read: if true;
      
      // Creación: Usuario autenticado puede crear su propio perfil de proveedor
      allow create: if isAuthenticated() && isOwner(providerId);
      
      // Actualización: Solo el propio proveedor puede actualizar su perfil
      // NOTA: El campo 'status' solo puede ser cambiado por admin (no implementado aún)
      allow update: if isAuthenticated() && isOwner(providerId);
      
      // Eliminación: No permitida desde el cliente
      allow delete: if false;
    }

    // LEADS/MATCHES
    match /leads/{leadId} {
      // Lectura: El usuario o el proveedor involucrado pueden leer el lead
      allow read: if isAuthenticated() && (isLeadUser() || isLeadProvider());
      
      // Creación: Solo usuarios autenticados pueden crear leads
      // El userId debe coincidir con el usuario autenticado
      allow create: if isAuthenticated() && 
        request.resource.data.userId == request.auth.uid;
      
      // Actualización: Usuario o proveedor pueden actualizar el estado
      allow update: if isAuthenticated() && (isLeadUser() || isLeadProvider());
      
      // Eliminación: No permitida desde el cliente
      allow delete: if false;
    }

    // REGLA POR DEFECTO: Denegar todo lo que no esté explícitamente permitido
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
